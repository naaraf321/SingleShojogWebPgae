<!DOCTYPE html>
<html lang="bn">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>MCQ Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
      body {
        font-family: "Hind Siliguri", sans-serif;
        background-color: #f3f4f6;
      }
      .tag {
        background-color: #e5e7eb;
        color: #4b5563;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 0.875rem;
        margin-left: 8px;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-4 md:p-8">
    <main id="mcq" class="max-w-3xl mx-auto"></main>
    <script>
      const API_URL = 'https://wnqytfyplnfvylsffglv.supabase.co/rest/v1';
      const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InducXl0ZnlwbG5mdnlsc2ZmZ2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5ODM3MzYsImV4cCI6MjA1NzU1OTczNn0.MiqJv6b_xQn0vIUrdq0-C3rA8LMmizW3vz6oyxaLDgA';

      let mcqs = [];
      const subjectMap = new Map();
      const chapterMap = new Map();
      const topicMap = new Map();

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      async function fetchLookupData() {
        const tables = ['subjects', 'chapters', 'topics'];
        for (const table of tables) {
          const res = await fetch(`${API_URL}/${table}?select=id,name`, {
            headers: {
              apikey: API_KEY,
              Authorization: `Bearer ${API_KEY}`
            }
          });
          const data = await res.json();
          data.forEach(item => {
            if (table === 'subjects') subjectMap.set(item.id, item.name);
            else if (table === 'chapters') chapterMap.set(item.id, item.name);
            else if (table === 'topics') topicMap.set(item.id, item.name);
          });
        }
      }

      async function fetchMcqs(startId, endId) {
        await fetchLookupData();
        const url = `${API_URL}/mcqs?select=*&id=gte.${startId}&id=lte.${endId}`;
        const response = await fetch(url, {
          headers: {
            apikey: API_KEY,
            Authorization: `Bearer ${API_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        mcqs = await response.json();
        renderAllMcqs();
      }

      function renderAllMcqs() {
        let html = '';
        mcqs.forEach((mcq, index) => {
          html += `
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-semibold text-gray-800">${index + 1}. ${mcq.question_markdown}</h2>
                <div class="text-sm text-gray-500">${mcq.id}</div>
              </div>
              ${renderTags(mcq.source_info)}
              <div class="space-y-3 mt-4">
                ${renderOptions(mcq.options_json, mcq.correct_answer, mcq.id)}
              </div>
              <div class="flex items-center space-x-2 mt-6">
                <span class="tag">${chapterMap.get(mcq.chapter_id) || ''}</span>
                <span class="tag">${subjectMap.get(mcq.subject_id) || ''}</span>
                <span class="tag bg-indigo-100 text-indigo-700">${topicMap.get(mcq.topic_id) || ''}</span>
              </div>
              <div class="solution-box mt-6 p-4 border rounded bg-gray-50">
                <h3 class="font-semibold text-gray-700 mb-2">সঠিক উত্তর ও ব্যাখ্যা:</h3>
                <p class="text-green-600 font-medium mb-2">(${mcq.correct_answer})</p>
                <p class="text-sm text-gray-600 leading-relaxed">${mcq.answer_explanation || ''}</p>
                ${mcq.answer_image_url ? `<img src="${mcq.answer_image_url}" class="mt-4 rounded" />` : ''}
              </div>
            </div>
          `;
        });
        document.getElementById('mcq').innerHTML = html;
        MathJax.typeset();
      }

      function renderTags(sourceInfoJson) {
        let html = '<div class="flex flex-wrap items-center justify-end mb-4">';
        try {
          const source = JSON.parse(sourceInfoJson || '{}');
          const allTags = [];
          if (source.universities) {
            for (const [uni, year] of Object.entries(source.universities)) {
              allTags.push(`${uni} ${year}`);
            }
          }
          if (source.boards) {
            for (const [board, year] of Object.entries(source.boards)) {
              allTags.push(`${board} ${year}`);
            }
          }
          if (source.books?.length) {
            allTags.push(...source.books);
          }
          html += allTags.map(tag => `<span class="tag">${tag}</span>`).join('');
        } catch (e) {}
        html += '</div>';
        return html;
      }

      function renderOptions(optionsJson, correctAnswer, qid) {
        let html = '';
        try {
          const options = JSON.parse(optionsJson || '[]');
          options.forEach((opt) => {
            const key = opt.label;
            const value = opt.text;
            const isCorrect = opt.correct || (key === correctAnswer);
            const labelClass = isCorrect ? 'option-label correct' : 'option-label';
            html += `
              <label class="${labelClass}" for="q${qid}_opt${key}">
                <input id="q${qid}_opt${key}" name="question${qid}" type="radio" value="${key}" />
                <span>(${key}) ${value}</span>
              </label>
            `;
          });
        } catch (e) {
          html = '<p class="text-red-500 text-sm">Invalid options</p>';
        }
        return html;
      }

      const fromId = getQueryParam('from');
      const toId = getQueryParam('to');
      if (fromId && toId) {
        fetchMcqs(fromId, toId);
      } else {
        document.getElementById('mcq').innerHTML = '<p class="text-red-500">Please provide "from" and "to" query parameters in the URL.</p>';
      }
    </script>
  </body>
</html>
